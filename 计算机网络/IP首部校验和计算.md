IP数据报首部检验和是一种用于确保IP数据包头部在传输过程中完整性的差错校验机制。下面这张流程图直观展示了发送端和接收端的完整计算和验证过程，你可以通过它快速把握整体流程：

```
flowchart TD
    A[发送端计算检验和] --> B[检验和字段置0]
    B --> C[16位单元二进制反码求和]
    C --> D{高16位是否为0?}
    D -- 否 --> E[高16位与低16位相加<br>结果存回低16位]
    E --> D
    D -- 是 --> F[对最终16位结果取反]
    F --> G[填入检验和字段并发送]
    
    H[接收端验证检验和] --> I[对包含检验和的整个首部<br>进行二进制反码求和]
    I --> J{最终结果是否全1?}
    J -- 是 --> K[校验成功<br>数据包完整]
    J -- 否 --> L[校验失败<br>丢弃数据包]
```

下面是计算和验证过程的详细分解。

### 🔢 发送方计算步骤

1. **初始化**：将IP数据报首部中的**检验和字段全部置为0** 。
2. **分段求和**：将整个IP首部（通常为20字节，除非包含选项）视为一系列**16位（2字节）的单元**，将这些单元的值进行累加。如果首部长度是奇数，会进行填充处理 。这个累加过程通常使用32位或更大的变量来进行，以保存进位 。
3. **处理进位**：将累加结果的高16位与低16位相加，再将新的高16位进位加到低16位，重复此过程，直到高16位为0，得到一个16位的结果 。这个过程被称为"回卷"（Folding）。
4. **取反存储**：将上述得到的16位结果**按位取反**（即0变成1，1变成0），所得的数值就是检验和，将其填入IP首部的检验和字段 。

### ✅ 接收方验证步骤

1. **整体求和**：将接收到的IP数据报首部（包括发送方计算好的检验和字段）同样视为16位单元的序列，进行二进制反码求和（包括处理进位）。
2. **结果校验**：验证最终的计算结果。如果首部在传输过程中**没有发生任何错误**，那么最终求和的结果应为**16位全1（即0xFFFF）** 。这是因为接收方的计算包含了发送方存入的检验和（即发送方计算结果的取反），如果数据无误，两者相加应得到全1。

### ⚙️ 核心算法与示例

核心的检验和计算算法通常用以下C语言函数实现 ：

```
unsigned short checksum(unsigned short *addr, int len) {
    unsigned long sum = 0; // 使用32位变量保存累加和
    while (len > 1) {
        sum += *addr++;   // 将16位单元相加
        len -= 2;
    }
    if (len == 1) { // 处理奇数长度的情况，最后一个字节补0
        sum += *(unsigned char *)addr;
    }
    // 处理进位，将高16位与低16位相加，直到高16位为0
    sum = (sum >> 16) + (sum & 0xffff);
    sum += (sum >> 16);
    return (unsigned short)(~sum); // 取反后返回16位检验和
}
```

来看一个计算实例 ：

IP头部（检验和字段已置0）：

```
4500 0031 89F5 0000 6E06 0000 DEB7 455D C0A8 00DC
```

1. **求和**：`4500 + 0031 + 89F5 + 0000 + 6E06 + 0000 + DEB7 + 455D + C0A8 + 00DC = 0x322C4`
2. **处理进位**：`0x0003 (高16位) + 0x22C4 (低16位) = 0x22C7`
3. **取反**：`~0x22C7 = 0xDD38`→ 此即检验和。

接收方验证时，将包含检验和`0xDD38`的整个头部相加，正确处理进位后，结果应为`0xFFFF`。

### 💡 重要特性与比较

- **端序独立性**：IP检验和采用的二进制反码求和算法是**端序无关的**（Endian-independent）。这意味着无论主机使用的是大端序还是小端序，计算得到的检验和值都是一样的，简化了不同架构机器间的通信 。
- **范围有限**：IP检验和**只覆盖IP首部**，不校验数据部分。而TCP、UDP、ICMP等协议的检验和则覆盖其首部和数据 。此外，TCP和UDP检验和计算时还会引入一个**伪首部**（Pseudo-header），包含源IP、目的IP、协议类型和长度等信息，以提供更进一步的验证 。
- **效率考量**：由于IP首部中的某些字段（如TTL）在传输路径上每经过一个路由器就会改变，采用这种校验和算法，路由器在转发时可以通过增量更新检验和来提高效率，而不必每次都对整个首部重新计算 。

希望这些详细的解释和示例能帮助你彻底理解IP数据报首部检验和的计算与验证。如果你对某个具体步骤或与其他协议检验和的区别有进一步疑问，我很乐意继续探讨。